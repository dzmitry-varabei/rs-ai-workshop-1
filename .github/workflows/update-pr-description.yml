name: Update PR Description

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  update-pr-description:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find PR description file
        id: find-description
        run: |
          # Try to find PR_DESCRIPTION_*.md file in root
          DESC_FILE=$(find . -maxdepth 1 -name "PR_DESCRIPTION*.md" | head -1)
          if [ -z "$DESC_FILE" ]; then
            echo "No PR description file found"
            echo "file_exists=false" >> $GITHUB_OUTPUT
          else
            echo "Found: $DESC_FILE"
            echo "file_path=$DESC_FILE" >> $GITHUB_OUTPUT
            echo "file_exists=true" >> $GITHUB_OUTPUT
          fi

      - name: Get PR description from file
        id: get-description
        if: steps.find-description.outputs.file_exists == 'true'
        run: |
          DESC=$(cat "${{ steps.find-description.outputs.file_path }}")
          # Escape for JSON and remove markdown code blocks if present
          DESC_CLEAN=$(echo "$DESC" | sed 's/^# Pull Request: //' | sed 's/^## /### /')
          DESC_ESCAPED=$(echo "$DESC_CLEAN" | jq -Rs .)
          echo "description=$DESC_ESCAPED" >> $GITHUB_OUTPUT

      - name: Update PR description from file
        if: steps.find-description.outputs.file_exists == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const description = ${{ steps.get-description.outputs.description }};
            
            if (description && description.trim() !== '') {
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                body: description
              });
              console.log('PR description updated from file');
            }


